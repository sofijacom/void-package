name: Build and Release Void Linux Packages

env:
  # TAG: workflow-${{ github.run_number }}
  TAG: build-${{ github.run_number }}-${{ github.sha }}
  SHA: ${{ github.sha }}

on:
  workflow_dispatch:
    inputs:
      force_package:
        description: "Force rebuild of a specific package (optional)"
        required: false
        default: ""
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - srcpkgs/**

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ------------------------------------------------------------
# 1. PREPARE — merge repo into void-packages and archive
# ------------------------------------------------------------
jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: void-linux/void-packages
          ref: master

      - name: Merge this repository into void-linux/void-packages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "*"

          git remote add -f sofijacom https://github.com/sofijacom/void-package.git
          git merge --no-commit --strategy-option=theirs --allow-unrelated-histories -Xignore-space-change sofijacom/main

          find -mindepth 1 -maxdepth 1 -exec tar czf source.tgz {} \+

      - uses: actions/upload-artifact@v4
        with:
          name: source
          path: source.tgz
          retention-days: 1
          # include-hidden-files: true

# ------------------------------------------------------------
# 2. INIT — detect changed packages and produce matrix
# ------------------------------------------------------------
  init:
    needs: prepare
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' }}
    container:
      image: ghcr.io/void-linux/void-glibc-full:20250901R1
      options: --platform linux/amd64
      env:
        ARCH: x86_64
        XBPS_TARGET_ARCH: x86_64
    outputs:
      matrix: ${{ steps.find-packages.outputs.matrix }}

    steps:
      - name: Prep container
        run: |
          mkdir -p /etc/xbps.d
          cp /usr/share/xbps.d/*-repository-*.conf /etc/xbps.d/
          xbps-install -Syu xbps
          xbps-install -yu
          xbps-install -y bash curl git github-cli tar jq sudo
          useradd -G xbuilder -M builder -s /bin/bash

      - uses: actions/download-artifact@v4
        with:
          name: source

      - run: |
          mkdir -p /work
          tar xzf source.tgz -C /work --strip-components=1

      - id: find-packages
        working-directory: /work
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --global --add safe.directory /work

          latest_tag=$(echo "")

          if [ -z "$latest_tag" ]; then
            echo "No previous release found, using previous commit"
            if git rev-parse sofijacom/main~1 >/dev/null 2>&1; then
              latest_sha=$(git rev-list --max-count=1 sofijacom/main~1)
            else
              # First commit fallback
              latest_sha=$(git rev-list --max-parents=0 sofijacom/main)
            fi
          else
            latest_sha=$(git rev-list --max-count=1 "$latest_tag")
          fi

          echo "Latest Tag: ${latest_tag}"
          echo "Latest Tag SHA: ${latest_sha}"

          change=$(git diff-tree -r --no-renames --name-only --diff-filter=AM ${latest_sha} ${SHA} -- 'srcpkgs/**' | cut -d/ -f2 | uniq)

          if [ -n "${{ github.event.inputs.force_package }}" ]; then
            change="$change ${{ github.event.inputs.force_package }}"
          fi

          chown -R builder:builder .

          if [ -z "$change" ]; then
            echo "[]" > /tmp/matrix.json
          else
            echo "$change" | sudo -Eu builder xargs ./xbps-src sort-dependencies | jq -R | jq -cs | tee /tmp/matrix.json
          fi

          echo "matrix=$(cat /tmp/matrix.json)" >> $GITHUB_OUTPUT

# ------------------------------------------------------------
# 3. BUILD — parallel builds, isolated dirs, upload artifacts
# ------------------------------------------------------------
  build:
    needs: init
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' && needs.init.outputs.matrix != '[]' }}
    # permissions:
    #   contents: write
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.init.outputs.matrix) }}
        arch:
          - x86_64
          # - x86_64-musl
        include:
          - arch: x86_64
            libc: glibc
          # - arch: x86_64-musl
          #   libc: musl
    container:
      image: ghcr.io/void-linux/void-buildroot-${{ matrix.libc }}:latest
      options: --platform linux/amd64

    steps:
      - name: Prep container
        run: |
          echo "/usr/libexec/chroot-git" >> "$GITHUB_PATH"
          xbps-install -Syu xbps
          xbps-install -yu
          xbps-install -y tar

      - uses: actions/download-artifact@v4
        with:
          name: source

      - run: |
          mkdir -p /work
          tar xzf source.tgz -C /work --strip-components=1


      - name: Cache distfiles
        uses: actions/cache@v4
        with:
          path: /work/hostdir/distfiles
          key: distfiles-${{ matrix.libc }}-${{ matrix.arch }}-${{ hashFiles('srcpkgs/**/template') }}
          restore-keys: |
            distfiles-${{ matrix.libc }}-${{ matrix.arch }}-

      - name: Download released packages
        working-directory: /work
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p hostdir/binpkgs

          gh release download --pattern "*${{ matrix.arch }}*.xbps" --dir hostdir/binpkgs --repo sofijacom/void-package || true

          echo "Downloaded previous packages for arch ${{ matrix.arch }}"

      - name: Configure xbps-src
        working-directory: /work
        run: |
          cat <<EOF >> etc/conf
          XBPS_BUILD_ENVIRONMENT=ci
          XBPS_ALLOW_RESTRICTED=yes
          XBPS_CHROOT_CMD=ethereal
          XBPS_ALLOW_CHROOT_BREAKOUT=yes
          XBPS_MAKEJOBS=$(nproc)
          EOF

          [ -e masterdir ] || ln -s / masterdir

      # -------------------- Packages to build --------------------

      - id: build-package
        working-directory: /work
        run: |
          ./xbps-src pkg "${{ matrix.package }}"
          pkgfile=$(ls hostdir/binpkgs/*.xbps | head -n1)
          echo "pkg=$(basename "$pkgfile")" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: void-${{ matrix.package }}-${{ matrix.libc }}
          path: /work/hostdir/binpkgs/*.xbps

      - if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.package }}-${{ matrix.libc }}
          path: /work/builddir/.xbps-src*log

# ------------------------------------------------------------
# 4. RELEASE — merge artifacts, sign repo, publish release
# ------------------------------------------------------------
  newrelease:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.ref == 'refs/heads/main' && needs.build.result == 'success' }}
    container:
      image: ghcr.io/void-linux/void-buildroot-glibc:latest
      options: --platform linux/amd64

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: /repo
          pattern: void-*
          merge-multiple: true

      - name: Clean & sign
        working-directory: /repo
        env:
          PRIVKEY: ${{ secrets.PRIV_KEY }}
          XBPS_PASSPHRASE: ${{ secrets.SIGN_PASS }}
        run: |
          xbps-rindex --remove-obsoletes ${PWD}
          printf "%s\n" "${PRIVKEY}" > key.pem
          xbps-rindex --privkey key.pem --sign --signedby "${{ github.repository }}-github-actions" --verbose ${PWD}
          xbps-rindex --privkey key.pem --sign-pkg --verbose ${PWD}/*.xbps
          rm -f key.pem
          xbps-rindex --clean ${PWD}

      - name: checksum
        working-directory: /repo
        run: |
          rm -rf *.sha256sum *.sha512sum
          for file in *.xbps; do
            sha256sum "${file}" | cut -d ' ' -f1 > "${file}.sha256sum"
            sha512sum "${file}" | cut -d ' ' -f1 > "${file}.sha512sum"
          done

      - uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: "Build ${{ github.sha }}"
          tag_name: ${{ env.TAG }}
          files: /repo/*
